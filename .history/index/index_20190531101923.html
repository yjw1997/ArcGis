<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1, maximum-scale=1, user-scalable=no"
    />
    <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.11/esri/themes/light/main.css"
    />
    <script src="https://js.arcgis.com/4.11/"></script>
    <title>ArcGIS JavaScript Tutorials: Create a JavaScript starter app</title>
    <style>
      html,
      body,
      #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div id="viewDiv"></div>
  </body>
  <script>
    require([
      'esri/Map',
      'esri/views/MapView',
      //*** ADD ***//
      'esri/tasks/support/Query',
      'esri/tasks/QueryTask',
      'esri/Graphic'
    ], function(Map, MapView, Query, QueryTask, Graphic) {
      var map = new Map({
        basemap: 'satellite'
      })
      var view = new MapView({
        container: 'viewDiv',
        map: map,
        //*** ADD ***//
        center: [-118.80543, 34.027],
        zoom: 13
      })
      //  绘制一个徒步旅行者图像是一个picture-marker，18px在尺寸为每个点。使用url以下图像
      var trailheadsRenderer = {
        type: 'simple',
        symbol: {
          type: 'picture-marker',
          url:
            'http://static.arcgis.com/images/Symbols/NPS/npsPictograph_0231b.png',
          width: '100px',
          height: '100px'
        }
      }
      //  要显示跟踪名称标签，请创建一个trailheadsLabels对象以定义labelsInfo。设置为使用绿色光晕symbol绘制白色标签，将它们放在要素上方居中，并使用简单表达式引用该字段（要渲染的数据）
      var trailheadsLabels = {
        symbol: {
          type: 'text',
          color: '#FFFFFF',
          haloColor: '#5E8D74',
          haloSize: '2px',
          font: {
            size: '12px',
            family: 'noto-sans',
            style: 'italic',
            weight: 'normal'
          }
        },
        labelPlacement: 'above-center',
        labelExpressionInfo: {
          expression: '$feature.TRL_NAME'
        }
      }
      //  为trailheads定义一个弹出窗口
      var popupTrailheads = {
        title: 'Trailhead',
        content:
          '<b>City:</b> {CITY_JUR}<br><b>Cross Street:</b> {X_STREET}<br><b>Parking:</b> {PARKING}<br><b>Elevation:</b> {ELEV_FT} ft'
      }
      //  创建图层并设置弹出窗口
      var trailheads = new FeatureLayer({
        url:
          'https://services3.arcgis.com/GVgbJbqm8hXASVYi/arcgis/rest/services/Trailheads_Styled/FeatureServer/0',
        outFields: ['TRL_NAME', 'CITY_JUR', 'X_STREET', 'PARKING', 'ELEV_FT'],
        renderer: trailheadsRenderer,
        labelingInfo: [trailheadsLabels],
        popupTemplate: popupTrailheads
      })
      //  添加图层
      map.add(trailheads)
      //为Trails定义弹出窗口
      var popupTrails = {
        title: 'Trail Information',
        content: function() {
          return 'This is {TRL_NAME} with {ELEV_GAIN} ft of climbing.'
        }
      }

      var trails = new FeatureLayer({
        url:
          'https://services3.arcgis.com/GVgbJbqm8hXASVYi/arcgis/rest/services/Trails_Styled/FeatureServer/0',
        outFields: ['TRL_NAME', 'ELEV_GAIN'],
        popupTemplate: popupTrails
      })

      map.add(trails, 0)
      //  为Parks和OpenSpace定义弹出窗口
      var popupOpenspaces = {
        title: '{PARK_NAME}',
        content: [
          {
            type: 'fields',
            fieldInfos: [
              {
                fieldName: 'AGNCY_NAME',
                label: 'Agency',
                isEditable: true,
                tooltip: '',
                visible: true,
                format: null,
                stringFieldOption: 'textbox'
              },
              {
                fieldName: 'TYPE',
                label: 'Type',
                isEditable: true,
                tooltip: '',
                visible: true,
                format: null,
                stringFieldOption: 'textbox'
              },
              {
                fieldName: 'ACCESS_TYP',
                label: 'Access',
                isEditable: true,
                tooltip: '',
                visible: true,
                format: null,
                stringFieldOption: 'textbox'
              },
              {
                fieldName: 'GIS_ACRES',
                label: 'Acres',
                isEditable: true,
                tooltip: '',
                visible: true,
                format: {
                  places: 2,
                  digitSeparator: true
                },
                stringFieldOption: 'textbox'
              }
            ]
          }
        ]
      }

      var openspaces = new FeatureLayer({
        url:
          'https://services3.arcgis.com/GVgbJbqm8hXASVYi/arcgis/rest/services/Parks_and_Open_Space_Styled/FeatureServer/0',
        outFields: [
          'TYPE',
          'PARK_NAME',
          'AGNCY_NAME',
          'ACCESS_TYP',
          'GIS_ACRES'
        ],
        popupTemplate: popupOpenspaces
      })

      map.add(openspaces, 0)
      // Define query SQL expression
      var query = new Query()
      query.where = "TRL_NAME like '%backbone%'"
      query.outFields = ['*']
      query.returnGeometry = true

      // Define the query task
      var queryTask = new QueryTask({
        url:
          'https://services3.arcgis.com/GVgbJbqm8hXASVYi/arcgis/rest/services/Trails/FeatureServer/0'
      })

      // Execute the query
      queryTask
        .execute(query)
        .then(function(result) {
          console.log(result.features.length)
        })
        .otherwise(function(e) {
          console.log(e)
        })
    })
  </script>
</html>
